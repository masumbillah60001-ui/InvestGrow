// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADVISOR
  ADMIN
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

model User {
  id                String      @id @default(auto()) @map("_id") @db.ObjectId
  email             String      @unique
  phone             String?     @unique
  passwordHash      String
  
  firstName         String
  lastName          String?
  dateOfBirth       DateTime?
  
  panNumber         String?     @unique
  kycStatus         KycStatus   @default(PENDING)
  role              UserRole    @default(USER)
  
  isEmailVerified   Boolean     @default(false)
  isPhoneVerified   Boolean     @default(false)
  profileImageUrl   String?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  lastLoginAt       DateTime?
  isActive          Boolean     @default(true)
  
  // Relations
  investments       UserInvestment[]
  consultations     ConsultationRequest[]
  kycDocuments      KycDocument[]
  sessions          Session[]
  auditLogs         AuditLog[]
  contactMessages   ContactMessage[]
  
  @@index([email])
  @@index([phone])
  @@index([panNumber])
  @@map("users")
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

enum InvestmentType {
  SIP
  LUMPSUM
  BOTH
}

model InvestmentPlan {
  id                      String          @id @default(auto()) @map("_id") @db.ObjectId
  planName                String
  planCode                String          @unique
  description             String?
  
  minInvestmentAmount     Decimal         @db.Decimal(12, 2)
  maxInvestmentAmount     Decimal?        @db.Decimal(12, 2)
  suggestedSipAmount      Decimal?        @db.Decimal(12, 2)
  
  riskLevel               RiskLevel
  investmentType          InvestmentType
  lockInPeriodMonths      Int             @default(0)
  
  features                Json?
  targetAudience          String[]
  
  isActive                Boolean         @default(true)
  displayOrder            Int             @default(0)
  
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  
  // Relations
  userInvestments         UserInvestment[]
  
  @@index([isActive])
  @@index([planCode])
  @@map("investment_plans")
}

enum InvestmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum SipFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
}

model UserInvestment {
  id                    String              @id @default(auto()) @map("_id") @db.ObjectId
  
  userId                String              @db.ObjectId
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  planId                String?             @db.ObjectId
  plan                  InvestmentPlan?     @relation(fields: [planId], references: [id])
  
  investmentType        InvestmentType
  
  sipAmount             Decimal?            @db.Decimal(12, 2)
  sipDate               Int?                // Day of month (1-28)
  sipFrequency          SipFrequency?
  
  lumpSumAmount         Decimal?            @db.Decimal(12, 2)
  
  startDate             DateTime
  endDate               DateTime?
  status                InvestmentStatus    @default(ACTIVE)
  
  totalInvested         Decimal             @default(0) @db.Decimal(15, 2)
  currentValue          Decimal             @default(0) @db.Decimal(15, 2)
  lastTransactionDate   DateTime?
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([sipDate])
  @@map("user_investments")
}

enum ConsultationStatus {
  PENDING
  CONTACTED
  SCHEDULED
  COMPLETED
  CANCELLED
}

model ConsultationRequest {
  id                          String              @id @default(auto()) @map("_id") @db.ObjectId
  
  userId                      String?             @db.ObjectId
  user                        User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  fullName                    String
  email                       String
  phone                       String
  message                     String?
  
  preferredDate               DateTime?
  preferredTime               String?
  
  investmentGoal              String?
  monthlyInvestmentCapacity   Decimal?            @db.Decimal(12, 2)
  
  status                      ConsultationStatus  @default(PENDING)
  assignedAdvisorId           String?
  notes                       String?
  
  createdAt                   DateTime            @default(now())
  updatedAt                   DateTime            @updatedAt
  
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@map("consultation_requests")
}

enum MessageStatus {
  NEW
  READ
  REPLIED
  ARCHIVED
}

model ContactMessage {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId
  
  userId          String?         @db.ObjectId
  user            User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  fullName        String
  email           String
  phone           String?
  subject         String?
  message         String
  
  status          MessageStatus   @default(NEW)
  repliedBy       String?
  replyMessage    String?
  repliedAt       DateTime?
  
  createdAt       DateTime        @default(now())
  
  @@index([status])
  @@index([createdAt])
  @@map("contact_messages")
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model BlogPost {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  
  title             String
  slug              String        @unique
  excerpt           String?
  content           String
  
  featuredImageUrl  String?
  authorId          String?
  
  category          String?
  tags              String[]
  readTimeMinutes   Int?
  
  seoTitle          String?
  seoDescription    String?
  seoKeywords       String[]
  
  status            PostStatus    @default(DRAFT)
  publishedAt       DateTime?
  viewsCount        Int           @default(0)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([category])
  @@map("blog_posts")
}

model NewsletterSubscriber {
  id                  String      @id @default(auto()) @map("_id") @db.ObjectId
  
  email               String      @unique
  fullName            String?
  subscriptionSource  String?
  
  isActive            Boolean     @default(true)
  subscribedAt        DateTime    @default(now())
  unsubscribedAt      DateTime?
  
  @@index([email])
  @@index([isActive])
  @@map("newsletter_subscribers")
}

enum DocumentType {
  PAN_CARD
  AADHAAR
  BANK_STATEMENT
  CANCELLED_CHEQUE
  ADDRESS_PROOF
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model KycDocument {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId
  
  userId              String              @db.ObjectId
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  documentType        DocumentType
  documentUrl         String
  documentNumber      String?
  
  verificationStatus  VerificationStatus  @default(PENDING)
  verifiedBy          String?
  verifiedAt          DateTime?
  rejectionReason     String?
  
  uploadedAt          DateTime            @default(now())
  
  @@index([userId])
  @@index([verificationStatus])
  @@map("kyc_documents")
}

model Session {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  
  userId            String    @db.ObjectId
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  refreshToken      String    @unique
  deviceInfo        Json?
  ipAddress         String?
  
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  lastActivityAt    DateTime  @default(now())
  
  @@index([userId])
  @@index([refreshToken])
  @@index([expiresAt])
  @@map("sessions")
}

model AuditLog {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  
  userId      String?   @db.ObjectId
  user        User?     @relation(fields: [userId], references: [id])
  
  action      String
  entityType  String?
  entityId    String?
  
  oldValues   Json?
  newValues   Json?
  
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
